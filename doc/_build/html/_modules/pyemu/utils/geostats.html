<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>pyemu.utils.geostats &#8212; pyEMU 1.0 documentation</title>
    
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for pyemu.utils.geostats</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span> <span class="k">as</span> <span class="nn">mp</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">pyemu</span> <span class="k">import</span> <span class="n">Cov</span>
<span class="kn">from</span> <span class="nn">pyemu.utils.gw_utils</span> <span class="k">import</span> <span class="n">pp_file_to_dataframe</span>
<span class="c1">#from pyemu.utils.reference import SpatialReference</span>

<span class="c1">#TODO:  plot variogram elipse</span>

<span class="n">EPSILON</span> <span class="o">=</span> <span class="mf">1.0e-7</span>

<span class="c1"># class KrigeFactors(pd.DataFrame):</span>
<span class="c1">#     def __init__(self,*args,**kwargs):</span>
<span class="c1">#         super(KrigeFactors,self).__init__(*args,**kwargs)</span>
<span class="c1">#</span>
<span class="c1">#     def to_factors(self,filename,nrow,ncol,</span>
<span class="c1">#                    points_file=&quot;points.junk&quot;,</span>
<span class="c1">#                    zone_file=&quot;zone.junk&quot;):</span>
<span class="c1">#         with open(filename,&#39;w&#39;) as f:</span>
<span class="c1">#             f.write(points_file+&#39;\n&#39;)</span>
<span class="c1">#             f.write(zone_file+&#39;\n&#39;)</span>
<span class="c1">#             f.write(&quot;{0} {1}\n&quot;.format(ncol,nrow))</span>
<span class="c1">#             f.write(&quot;{0}\n&quot;.format(self.shape[0]))</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#     def from_factors(self,filename):</span>
<span class="c1">#         raise NotImplementedError()</span>



<div class="viewcode-block" id="GeoStruct"><a class="viewcode-back" href="../../../_static/pyemu.utils.html#pyemu.utils.geostats.GeoStruct">[docs]</a><span class="k">class</span> <span class="nc">GeoStruct</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;a geostatistical structure object</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        nugget : float</span>
<span class="sd">            nugget contribution</span>
<span class="sd">        variograms : list</span>
<span class="sd">            list of Vario2d instances</span>
<span class="sd">        name : str</span>
<span class="sd">            name to assign the structure</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">nugget</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span><span class="n">variograms</span><span class="o">=</span><span class="p">[],</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;struct1&quot;</span><span class="p">,</span>
                 <span class="n">transform</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nugget</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">nugget</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">variograms</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
            <span class="n">variograms</span> <span class="o">=</span> <span class="p">[</span><span class="n">variograms</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">vario</span> <span class="ow">in</span> <span class="n">variograms</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vario</span><span class="p">,</span><span class="n">Vario2d</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">variograms</span> <span class="o">=</span> <span class="n">variograms</span>
        <span class="n">transform</span> <span class="o">=</span> <span class="n">transform</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">transform</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;none&quot;</span><span class="p">,</span><span class="s2">&quot;log&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">transform</span>

<div class="viewcode-block" id="GeoStruct.to_struct_file"><a class="viewcode-back" href="../../../_static/pyemu.utils.html#pyemu.utils.geostats.GeoStruct.to_struct_file">[docs]</a>    <span class="k">def</span> <span class="nf">to_struct_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;STRUCTURE </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;  NUGGET </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nugget</span><span class="p">))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;  NUMVARIOGRAM </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">variograms</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">variograms</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;  VARIOGRAM </span><span class="si">{0}</span><span class="s2"> </span><span class="si">{1}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="n">v</span><span class="o">.</span><span class="n">contribution</span><span class="p">))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;  TRANSFORM </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;END STRUCTURE</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">variograms</span><span class="p">:</span>
            <span class="n">v</span><span class="o">.</span><span class="n">to_struct_file</span><span class="p">(</span><span class="n">f</span><span class="p">)</span></div>

<div class="viewcode-block" id="GeoStruct.covariance_matrix"><a class="viewcode-back" href="../../../_static/pyemu.utils.html#pyemu.utils.geostats.GeoStruct.covariance_matrix">[docs]</a>    <span class="k">def</span> <span class="nf">covariance_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">cov</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;build a pyemu.Cov instance from GeoStruct</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">            x : iterable of floats</span>
<span class="sd">                x locations</span>
<span class="sd">            y : iterable of floats</span>
<span class="sd">                y locations</span>
<span class="sd">            names : iterable of str (optional)</span>
<span class="sd">                names of location. If None, generic names will be used</span>
<span class="sd">            cov : pyemu.Cov instance (optional)</span>
<span class="sd">                an existing Cov instance to add contribution to</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">            pyemu.Cov</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">names</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)))</span>
            <span class="n">np</span><span class="o">.</span><span class="n">fill_diagonal</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">nugget</span><span class="p">)</span>
            <span class="n">cov</span> <span class="o">=</span> <span class="n">Cov</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">c</span><span class="p">,</span><span class="n">names</span><span class="o">=</span><span class="n">names</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">cov</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">cov</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">names</span> <span class="o">=</span> <span class="n">cov</span><span class="o">.</span><span class="n">row_names</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">),</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">c</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nugget</span>
            <span class="n">cont</span> <span class="o">=</span> <span class="n">Cov</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">c</span><span class="p">,</span><span class="n">names</span><span class="o">=</span><span class="n">names</span><span class="p">,</span><span class="n">isdiagonal</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">cov</span> <span class="o">+=</span> <span class="n">cont</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;GeoStruct.covariance_matrix() requires either &quot;</span> <span class="o">+</span>
                            <span class="s2">&quot;names or cov arg&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">variograms</span><span class="p">:</span>
            <span class="n">v</span><span class="o">.</span><span class="n">covariance_matrix</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">cov</span><span class="o">=</span><span class="n">cov</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cov</span></div>

<div class="viewcode-block" id="GeoStruct.covariance"><a class="viewcode-back" href="../../../_static/pyemu.utils.html#pyemu.utils.geostats.GeoStruct.covariance">[docs]</a>    <span class="k">def</span> <span class="nf">covariance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">pt0</span><span class="p">,</span><span class="n">pt1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;get the covariance between two points implied by the GeoStruct</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">            pt0 : iterable length 2 of floats</span>
<span class="sd">            pt1 : iterable length 2 of floats</span>
<span class="sd">        Returns</span>
<span class="sd">            float : covariance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#raise Exception()</span>
        <span class="n">cov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nugget</span>
        <span class="k">for</span> <span class="n">vario</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">variograms</span><span class="p">:</span>
            <span class="n">cov</span> <span class="o">+=</span> <span class="n">vario</span><span class="o">.</span><span class="n">covariance</span><span class="p">(</span><span class="n">pt0</span><span class="p">,</span><span class="n">pt1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cov</span></div>

<div class="viewcode-block" id="GeoStruct.covariance_points"><a class="viewcode-back" href="../../../_static/pyemu.utils.html#pyemu.utils.geostats.GeoStruct.covariance_points">[docs]</a>    <span class="k">def</span> <span class="nf">covariance_points</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x0</span><span class="p">,</span><span class="n">y0</span><span class="p">,</span><span class="n">xother</span><span class="p">,</span><span class="n">yother</span><span class="p">):</span>
        <span class="n">cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">xother</span><span class="p">)))</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">nugget</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">variograms</span><span class="p">:</span>
            <span class="n">cov</span> <span class="o">+=</span> <span class="n">v</span><span class="o">.</span><span class="n">covariance_points</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span><span class="n">y0</span><span class="p">,</span><span class="n">xother</span><span class="p">,</span><span class="n">yother</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cov</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sill</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sill</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nugget</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">variograms</span><span class="p">:</span>
            <span class="n">sill</span> <span class="o">+=</span> <span class="n">v</span><span class="o">.</span><span class="n">contribution</span>
        <span class="k">return</span> <span class="n">sill</span>


<div class="viewcode-block" id="GeoStruct.plot"><a class="viewcode-back" href="../../../_static/pyemu.utils.html#pyemu.utils.geostats.GeoStruct.plot">[docs]</a>    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="s2">&quot;ax&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;ax&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
        <span class="n">legend</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;legend&quot;</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">individuals</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;individuals&quot;</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">xmx</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">v</span><span class="o">.</span><span class="n">a</span><span class="o">*</span><span class="mf">3.0</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">variograms</span><span class="p">])</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">xmx</span><span class="p">,</span><span class="mi">100</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">variograms</span><span class="p">:</span>
            <span class="n">yv</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">inv_h</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">individuals</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">yv</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="n">v</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">+=</span> <span class="n">yv</span>
        <span class="n">y</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nugget</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">legend</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;distance&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;$\gamma$&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ax</span></div>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;name:</span><span class="si">{0}</span><span class="s1">,nugget:</span><span class="si">{1}</span><span class="s1">,structures:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">nugget</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">variograms</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">s</span></div>


<span class="c1"># class LinearUniversalKrige(object):</span>
<span class="c1">#     def __init__(self,geostruct,point_data):</span>
<span class="c1">#         if isinstance(geostruct,str):</span>
<span class="c1">#             geostruct = read_struct_file(geostruct)</span>
<span class="c1">#         assert isinstance(geostruct,GeoStruct),&quot;need a GeoStruct, not {0}&quot;.\</span>
<span class="c1">#             format(type(geostruct))</span>
<span class="c1">#         self.geostruct = geostruct</span>
<span class="c1">#         if isinstance(point_data,str):</span>
<span class="c1">#             point_data = pp_file_to_dataframe(point_data)</span>
<span class="c1">#         assert isinstance(point_data,pd.DataFrame)</span>
<span class="c1">#         assert &#39;name&#39; in point_data.columns,&quot;point_data missing &#39;name&#39;&quot;</span>
<span class="c1">#         assert &#39;x&#39; in point_data.columns, &quot;point_data missing &#39;x&#39;&quot;</span>
<span class="c1">#         assert &#39;y&#39; in point_data.columns, &quot;point_data missing &#39;y&#39;&quot;</span>
<span class="c1">#         assert &quot;value&quot; in point_data.columns,&quot;point_data missing &#39;value&#39;&quot;</span>
<span class="c1">#         self.point_data = point_data</span>
<span class="c1">#         self.point_data.index = self.point_data.name</span>
<span class="c1">#         self.interp_data = None</span>
<span class="c1">#         self.spatial_reference = None</span>
<span class="c1">#         #X, Y = np.meshgrid(point_data.x,point_data.y)</span>
<span class="c1">#         #self.point_data_dist = pd.DataFrame(data=np.sqrt((X - X.T) ** 2 + (Y - Y.T) ** 2),</span>
<span class="c1">#         #                                    index=point_data.name,columns=point_data.name)</span>
<span class="c1">#         self.point_cov_df = self.geostruct.covariance_matrix(point_data.x,</span>
<span class="c1">#                                                             point_data.y,</span>
<span class="c1">#                                                             point_data.name).to_dataframe()</span>
<span class="c1">#         #for name in self.point_cov_df.index:</span>
<span class="c1">#         #    self.point_cov_df.loc[name,name] -= self.geostruct.nugget</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#     def estimate_grid(self,spatial_reference,zone_array=None,minpts_interp=1,</span>
<span class="c1">#                           maxpts_interp=20,search_radius=1.0e+10,verbose=False,</span>
<span class="c1">#                           var_filename=None):</span>
<span class="c1">#</span>
<span class="c1">#         self.spatial_reference = spatial_reference</span>
<span class="c1">#         self.interp_data = None</span>
<span class="c1">#         #assert isinstance(spatial_reference,SpatialReference)</span>
<span class="c1">#         try:</span>
<span class="c1">#             x = self.spatial_reference.xcentergrid.copy()</span>
<span class="c1">#             y = self.spatial_reference.ycentergrid.copy()</span>
<span class="c1">#         except Exception as e:</span>
<span class="c1">#             raise Exception(&quot;spatial_reference does not have proper attributes:{0}&quot;\</span>
<span class="c1">#                             .format(str(e)))</span>
<span class="c1">#</span>
<span class="c1">#         if var_filename is not None:</span>
<span class="c1">#             arr = np.zeros((self.spatial_reference.nrow,</span>
<span class="c1">#                             self.spatial_reference.ncol)) - 1.0e+30</span>
<span class="c1">#</span>
<span class="c1">#         df = self.estimate(x.ravel(),y.ravel(),</span>
<span class="c1">#                            minpts_interp=minpts_interp,</span>
<span class="c1">#                            maxpts_interp=maxpts_interp,</span>
<span class="c1">#                            search_radius=search_radius,</span>
<span class="c1">#                            verbose=verbose)</span>
<span class="c1">#         if var_filename is not None:</span>
<span class="c1">#             arr = df.err_var.values.reshape(x.shape)</span>
<span class="c1">#             np.savetxt(var_filename,arr,fmt=&quot;%15.6E&quot;)</span>
<span class="c1">#         arr = df.estimate.values.reshape(x.shape)</span>
<span class="c1">#         return arr</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#     def estimate(self,x,y,minpts_interp=1,maxpts_interp=20,</span>
<span class="c1">#                      search_radius=1.0e+10,verbose=False):</span>
<span class="c1">#         assert len(x) == len(y)</span>
<span class="c1">#</span>
<span class="c1">#         # find the point data to use for each interp point</span>
<span class="c1">#         sqradius = search_radius**2</span>
<span class="c1">#         df = pd.DataFrame(data={&#39;x&#39;:x,&#39;y&#39;:y})</span>
<span class="c1">#         inames,idist,ifacts,err_var = [],[],[],[]</span>
<span class="c1">#         estimates = []</span>
<span class="c1">#         sill = self.geostruct.sill</span>
<span class="c1">#         pt_data = self.point_data</span>
<span class="c1">#         ptx_array = pt_data.x.values</span>
<span class="c1">#         pty_array = pt_data.y.values</span>
<span class="c1">#         ptnames = pt_data.name.values</span>
<span class="c1">#         #if verbose:</span>
<span class="c1">#         print(&quot;starting interp point loop for {0} points&quot;.format(df.shape[0]))</span>
<span class="c1">#         start_loop = datetime.now()</span>
<span class="c1">#         for idx,(ix,iy) in enumerate(zip(df.x,df.y)):</span>
<span class="c1">#             if np.isnan(ix) or np.isnan(iy): #if nans, skip</span>
<span class="c1">#                 inames.append([])</span>
<span class="c1">#                 idist.append([])</span>
<span class="c1">#                 ifacts.append([])</span>
<span class="c1">#                 err_var.append(np.NaN)</span>
<span class="c1">#                 continue</span>
<span class="c1">#             if verbose:</span>
<span class="c1">#                 istart = datetime.now()</span>
<span class="c1">#                 print(&quot;processing interp point:{0} of {1}&quot;.format(idx,df.shape[0]))</span>
<span class="c1">#             # if verbose == 2:</span>
<span class="c1">#             #     start = datetime.now()</span>
<span class="c1">#             #     print(&quot;calc ipoint dist...&quot;,end=&#39;&#39;)</span>
<span class="c1">#</span>
<span class="c1">#             #  calc dist from this interp point to all point data...slow</span>
<span class="c1">#             dist = pd.Series((ptx_array-ix)**2 + (pty_array-iy)**2,ptnames)</span>
<span class="c1">#             dist.sort_values(inplace=True)</span>
<span class="c1">#             dist = dist.loc[dist &lt;= sqradius]</span>
<span class="c1">#</span>
<span class="c1">#             # if too few points were found, skip</span>
<span class="c1">#             if len(dist) &lt; minpts_interp:</span>
<span class="c1">#                 inames.append([])</span>
<span class="c1">#                 idist.append([])</span>
<span class="c1">#                 ifacts.append([])</span>
<span class="c1">#                 err_var.append(sill)</span>
<span class="c1">#                 estimates.append(np.NaN)</span>
<span class="c1">#                 continue</span>
<span class="c1">#</span>
<span class="c1">#             # only the maxpts_interp points</span>
<span class="c1">#             dist = dist.iloc[:maxpts_interp].apply(np.sqrt)</span>
<span class="c1">#             pt_names = dist.index.values</span>
<span class="c1">#             # if one of the points is super close, just use it and skip</span>
<span class="c1">#             if dist.min() &lt;= EPSILON:</span>
<span class="c1">#                 ifacts.append([1.0])</span>
<span class="c1">#                 idist.append([EPSILON])</span>
<span class="c1">#                 inames.append([dist.idxmin()])</span>
<span class="c1">#                 err_var.append(self.geostruct.nugget)</span>
<span class="c1">#                 estimates.append(self.point_data.loc[dist.idxmin(),&quot;value&quot;])</span>
<span class="c1">#                 continue</span>
<span class="c1">#             # if verbose == 2:</span>
<span class="c1">#             #     td = (datetime.now()-start).total_seconds()</span>
<span class="c1">#             #     print(&quot;...took {0}&quot;.format(td))</span>
<span class="c1">#             #     start = datetime.now()</span>
<span class="c1">#             #     print(&quot;extracting pt cov...&quot;,end=&#39;&#39;)</span>
<span class="c1">#</span>
<span class="c1">#             #vextract the point-to-point covariance matrix</span>
<span class="c1">#             point_cov = self.point_cov_df.loc[pt_names,pt_names]</span>
<span class="c1">#             # if verbose == 2:</span>
<span class="c1">#             #     td = (datetime.now()-start).total_seconds()</span>
<span class="c1">#             #     print(&quot;...took {0}&quot;.format(td))</span>
<span class="c1">#             #     print(&quot;forming ipt-to-point cov...&quot;,end=&#39;&#39;)</span>
<span class="c1">#</span>
<span class="c1">#             # calc the interp point to points covariance</span>
<span class="c1">#             ptx = self.point_data.loc[pt_names,&quot;x&quot;]</span>
<span class="c1">#             pty = self.point_data.loc[pt_names,&quot;y&quot;]</span>
<span class="c1">#             interp_cov = self.geostruct.covariance_points(ix,iy,ptx,pty)</span>
<span class="c1">#</span>
<span class="c1">#             if verbose == 2:</span>
<span class="c1">#                 td = (datetime.now()-start).total_seconds()</span>
<span class="c1">#                 print(&quot;...took {0}&quot;.format(td))</span>
<span class="c1">#                 print(&quot;forming lin alg components...&quot;,end=&#39;&#39;)</span>
<span class="c1">#</span>
<span class="c1">#             # form the linear algebra parts and solve</span>
<span class="c1">#             d = len(pt_names) + 3 # +1 for lagrange mult + 2 for x and y coords</span>
<span class="c1">#             npts = len(pt_names)</span>
<span class="c1">#             A = np.ones((d,d))</span>
<span class="c1">#             A[:npts,:npts] = point_cov.values</span>
<span class="c1">#             A[npts,npts] = 0.0 #unbiaised constraint</span>
<span class="c1">#             A[-2,:npts] = ptx #x coords for linear trend</span>
<span class="c1">#             A[:npts,-2] = ptx</span>
<span class="c1">#             A[-1,:npts] = pty #y coords for linear trend</span>
<span class="c1">#             A[:npts,-1] = pty</span>
<span class="c1">#             A[npts:,npts:] = 0</span>
<span class="c1">#             print(A)</span>
<span class="c1">#             rhs = np.ones((d,1))</span>
<span class="c1">#             rhs[:npts,0] = interp_cov</span>
<span class="c1">#             rhs[-2,0] = ix</span>
<span class="c1">#             rhs[-1,0] = iy</span>
<span class="c1">#             # if verbose == 2:</span>
<span class="c1">#             #     td = (datetime.now()-start).total_seconds()</span>
<span class="c1">#             #     print(&quot;...took {0}&quot;.format(td))</span>
<span class="c1">#             #     print(&quot;solving...&quot;,end=&#39;&#39;)</span>
<span class="c1">#             # # solve</span>
<span class="c1">#             facs = np.linalg.solve(A,rhs)</span>
<span class="c1">#             assert len(facs) - 3 == len(dist)</span>
<span class="c1">#             estimate = facs[-3] + (ix * facs[-2]) + (iy * facs[-1])</span>
<span class="c1">#             estimates.append(estimate[0])</span>
<span class="c1">#             err_var.append(float(sill + facs[-1] - sum([f*c for f,c in zip(facs[:-1],interp_cov)])))</span>
<span class="c1">#             inames.append(pt_names)</span>
<span class="c1">#</span>
<span class="c1">#             idist.append(dist.values)</span>
<span class="c1">#             ifacts.append(facs[:-1,0])</span>
<span class="c1">#             # if verbose == 2:</span>
<span class="c1">#             #     td = (datetime.now()-start).total_seconds()</span>
<span class="c1">#             #     print(&quot;...took {0}&quot;.format(td))</span>
<span class="c1">#             if verbose:</span>
<span class="c1">#                 td = (datetime.now()-istart).total_seconds()</span>
<span class="c1">#                 print(&quot;point took {0}&quot;.format(td))</span>
<span class="c1">#         df[&quot;idist&quot;] = idist</span>
<span class="c1">#         df[&quot;inames&quot;] = inames</span>
<span class="c1">#         df[&quot;ifacts&quot;] = ifacts</span>
<span class="c1">#         df[&quot;err_var&quot;] = err_var</span>
<span class="c1">#         df[&quot;estimate&quot;] = estimates</span>
<span class="c1">#         self.interp_data = df</span>
<span class="c1">#         td = (datetime.now() - start_loop).total_seconds()</span>
<span class="c1">#         print(&quot;took {0}&quot;.format(td))</span>
<span class="c1">#         return df</span>


<div class="viewcode-block" id="OrdinaryKrige"><a class="viewcode-back" href="../../../_static/pyemu.utils.html#pyemu.utils.geostats.OrdinaryKrige">[docs]</a><span class="k">class</span> <span class="nc">OrdinaryKrige</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">geostruct</span><span class="p">,</span><span class="n">point_data</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">geostruct</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
            <span class="n">geostruct</span> <span class="o">=</span> <span class="n">read_struct_file</span><span class="p">(</span><span class="n">geostruct</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">geostruct</span><span class="p">,</span><span class="n">GeoStruct</span><span class="p">),</span><span class="s2">&quot;need a GeoStruct, not </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span>\
            <span class="nb">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">geostruct</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">geostruct</span> <span class="o">=</span> <span class="n">geostruct</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">point_data</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
            <span class="n">point_data</span> <span class="o">=</span> <span class="n">pp_file_to_dataframe</span><span class="p">(</span><span class="n">point_data</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">point_data</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span>
        <span class="k">assert</span> <span class="s1">&#39;name&#39;</span> <span class="ow">in</span> <span class="n">point_data</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span><span class="s2">&quot;point_data missing &#39;name&#39;&quot;</span>
        <span class="k">assert</span> <span class="s1">&#39;x&#39;</span> <span class="ow">in</span> <span class="n">point_data</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="s2">&quot;point_data missing &#39;x&#39;&quot;</span>
        <span class="k">assert</span> <span class="s1">&#39;y&#39;</span> <span class="ow">in</span> <span class="n">point_data</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="s2">&quot;point_data missing &#39;y&#39;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">point_data</span> <span class="o">=</span> <span class="n">point_data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">point_data</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">point_data</span><span class="o">.</span><span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interp_data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spatial_reference</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1">#X, Y = np.meshgrid(point_data.x,point_data.y)</span>
        <span class="c1">#self.point_data_dist = pd.DataFrame(data=np.sqrt((X - X.T) ** 2 + (Y - Y.T) ** 2),</span>
        <span class="c1">#                                    index=point_data.name,columns=point_data.name)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">point_cov_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geostruct</span><span class="o">.</span><span class="n">covariance_matrix</span><span class="p">(</span><span class="n">point_data</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
                                                            <span class="n">point_data</span><span class="o">.</span><span class="n">y</span><span class="p">,</span>
                                                            <span class="n">point_data</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>
        <span class="c1">#for name in self.point_cov_df.index:</span>
        <span class="c1">#    self.point_cov_df.loc[name,name] -= self.geostruct.nugget</span>

<div class="viewcode-block" id="OrdinaryKrige.prep_for_ppk2fac"><a class="viewcode-back" href="../../../_static/pyemu.utils.html#pyemu.utils.geostats.OrdinaryKrige.prep_for_ppk2fac">[docs]</a>    <span class="k">def</span> <span class="nf">prep_for_ppk2fac</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">struct_file</span><span class="o">=</span><span class="s2">&quot;structure.dat&quot;</span><span class="p">,</span><span class="n">pp_file</span><span class="o">=</span><span class="s2">&quot;points.dat&quot;</span><span class="p">,):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="OrdinaryKrige.calc_factors_grid"><a class="viewcode-back" href="../../../_static/pyemu.utils.html#pyemu.utils.geostats.OrdinaryKrige.calc_factors_grid">[docs]</a>    <span class="k">def</span> <span class="nf">calc_factors_grid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">spatial_reference</span><span class="p">,</span><span class="n">zone_array</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">minpts_interp</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                          <span class="n">maxpts_interp</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">search_radius</span><span class="o">=</span><span class="mf">1.0e+10</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                          <span class="n">var_filename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">spatial_reference</span> <span class="o">=</span> <span class="n">spatial_reference</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interp_data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1">#assert isinstance(spatial_reference,SpatialReference)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spatial_reference</span><span class="o">.</span><span class="n">xcentergrid</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spatial_reference</span><span class="o">.</span><span class="n">ycentergrid</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;spatial_reference does not have proper attributes:</span><span class="si">{0}</span><span class="s2">&quot;</span>\
                            <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>

        <span class="k">if</span> <span class="n">var_filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">spatial_reference</span><span class="o">.</span><span class="n">nrow</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">spatial_reference</span><span class="o">.</span><span class="n">ncol</span><span class="p">))</span> <span class="o">-</span> <span class="mf">1.0e+30</span>

        <span class="c1"># the simple case of no zone array: ignore point_data zones</span>
        <span class="k">if</span> <span class="n">zone_array</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_factors</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span><span class="n">y</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span>
                               <span class="n">minpts_interp</span><span class="o">=</span><span class="n">minpts_interp</span><span class="p">,</span>
                               <span class="n">maxpts_interp</span><span class="o">=</span><span class="n">maxpts_interp</span><span class="p">,</span>
                               <span class="n">search_radius</span><span class="o">=</span><span class="n">search_radius</span><span class="p">,</span>
                               <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">var_filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">arr</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">err_var</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">var_filename</span><span class="p">,</span><span class="n">arr</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%15.6E</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">zone_array</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">zone_array</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>
            <span class="k">if</span> <span class="s2">&quot;zone&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">point_data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;&#39;zone&#39; columns not in point_data, assigning generic zone&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">point_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;zone&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">pt_data_zones</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">point_data</span><span class="o">.</span><span class="n">zone</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
            <span class="n">dfs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">pt_data_zone</span> <span class="ow">in</span> <span class="n">pt_data_zones</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">pt_data_zone</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">zone_array</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;pt zone </span><span class="si">{0}</span><span class="s2"> not in zone array </span><span class="si">{1}</span><span class="s2">, skipping&quot;</span><span class="o">.</span>\
                                  <span class="nb">format</span><span class="p">(</span><span class="n">pt_data_zone</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">zone_array</span><span class="p">)))</span>
                    <span class="k">continue</span>
                <span class="n">xzone</span><span class="p">,</span><span class="n">yzone</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span><span class="n">y</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">xzone</span><span class="p">[</span><span class="n">zone_array</span><span class="o">!=</span><span class="n">pt_data_zone</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
                <span class="n">yzone</span><span class="p">[</span><span class="n">zone_array</span><span class="o">!=</span><span class="n">pt_data_zone</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
                <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_factors</span><span class="p">(</span><span class="n">xzone</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span><span class="n">yzone</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span>
                                       <span class="n">minpts_interp</span><span class="o">=</span><span class="n">minpts_interp</span><span class="p">,</span>
                                       <span class="n">maxpts_interp</span><span class="o">=</span><span class="n">maxpts_interp</span><span class="p">,</span>
                                       <span class="n">search_radius</span><span class="o">=</span><span class="n">search_radius</span><span class="p">,</span>
                                       <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span><span class="n">pt_zone</span><span class="o">=</span><span class="n">pt_data_zone</span><span class="p">)</span>
                <span class="n">dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">var_filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">a</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">err_var</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                    <span class="n">na_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
                    <span class="n">arr</span><span class="p">[</span><span class="n">na_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">na_idx</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interp_data</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">interp_data</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;no interpolation took place...something is wrong&quot;</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dfs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">var_filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">var_filename</span><span class="p">,</span><span class="n">arr</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%15.6E</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="OrdinaryKrige.calc_factors"><a class="viewcode-back" href="../../../_static/pyemu.utils.html#pyemu.utils.geostats.OrdinaryKrige.calc_factors">[docs]</a>    <span class="k">def</span> <span class="nf">calc_factors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">minpts_interp</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">maxpts_interp</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                     <span class="n">search_radius</span><span class="o">=</span><span class="mf">1.0e+10</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                     <span class="n">pt_zone</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

        <span class="c1"># find the point data to use for each interp point</span>
        <span class="n">sqradius</span> <span class="o">=</span> <span class="n">search_radius</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;x&#39;</span><span class="p">:</span><span class="n">x</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">:</span><span class="n">y</span><span class="p">})</span>
        <span class="n">inames</span><span class="p">,</span><span class="n">idist</span><span class="p">,</span><span class="n">ifacts</span><span class="p">,</span><span class="n">err_var</span> <span class="o">=</span> <span class="p">[],[],[],[]</span>
        <span class="n">sill</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geostruct</span><span class="o">.</span><span class="n">sill</span>
        <span class="k">if</span> <span class="n">pt_zone</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ptx_array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">point_data</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">values</span>
            <span class="n">pty_array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">point_data</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">values</span>
            <span class="n">ptnames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">point_data</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">values</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pt_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">point_data</span>
            <span class="n">ptx_array</span> <span class="o">=</span> <span class="n">pt_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pt_data</span><span class="o">.</span><span class="n">zone</span><span class="o">==</span><span class="n">pt_zone</span><span class="p">,</span><span class="s2">&quot;x&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
            <span class="n">pty_array</span> <span class="o">=</span> <span class="n">pt_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pt_data</span><span class="o">.</span><span class="n">zone</span><span class="o">==</span><span class="n">pt_zone</span><span class="p">,</span><span class="s2">&quot;y&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
            <span class="n">ptnames</span> <span class="o">=</span> <span class="n">pt_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pt_data</span><span class="o">.</span><span class="n">zone</span><span class="o">==</span><span class="n">pt_zone</span><span class="p">,</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="c1">#if verbose:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;starting interp point loop for </span><span class="si">{0}</span><span class="s2"> points&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">start_loop</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,(</span><span class="n">ix</span><span class="p">,</span><span class="n">iy</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">x</span><span class="p">,</span><span class="n">df</span><span class="o">.</span><span class="n">y</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ix</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">iy</span><span class="p">):</span> <span class="c1">#if nans, skip</span>
                <span class="n">inames</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                <span class="n">idist</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                <span class="n">ifacts</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                <span class="n">err_var</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">NaN</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">istart</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;processing interp point:</span><span class="si">{0}</span><span class="s2"> of </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="c1"># if verbose == 2:</span>
            <span class="c1">#     start = datetime.now()</span>
            <span class="c1">#     print(&quot;calc ipoint dist...&quot;,end=&#39;&#39;)</span>

            <span class="c1">#  calc dist from this interp point to all point data...slow</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">((</span><span class="n">ptx_array</span><span class="o">-</span><span class="n">ix</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">pty_array</span><span class="o">-</span><span class="n">iy</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">ptnames</span><span class="p">)</span>
            <span class="n">dist</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dist</span> <span class="o">&lt;=</span> <span class="n">sqradius</span><span class="p">]</span>

            <span class="c1"># if too few points were found, skip</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">minpts_interp</span><span class="p">:</span>
                <span class="n">inames</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                <span class="n">idist</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                <span class="n">ifacts</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                <span class="n">err_var</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sill</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># only the maxpts_interp points</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="n">maxpts_interp</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">)</span>
            <span class="n">pt_names</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>
            <span class="c1"># if one of the points is super close, just use it and skip</span>
            <span class="k">if</span> <span class="n">dist</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">EPSILON</span><span class="p">:</span>
                <span class="n">ifacts</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="mf">1.0</span><span class="p">])</span>
                <span class="n">idist</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">EPSILON</span><span class="p">])</span>
                <span class="n">inames</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">dist</span><span class="o">.</span><span class="n">idxmin</span><span class="p">()])</span>
                <span class="n">err_var</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">geostruct</span><span class="o">.</span><span class="n">nugget</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="c1"># if verbose == 2:</span>
            <span class="c1">#     td = (datetime.now()-start).total_seconds()</span>
            <span class="c1">#     print(&quot;...took {0}&quot;.format(td))</span>
            <span class="c1">#     start = datetime.now()</span>
            <span class="c1">#     print(&quot;extracting pt cov...&quot;,end=&#39;&#39;)</span>

            <span class="c1">#vextract the point-to-point covariance matrix</span>
            <span class="n">point_cov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">point_cov_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pt_names</span><span class="p">,</span><span class="n">pt_names</span><span class="p">]</span>
            <span class="c1"># if verbose == 2:</span>
            <span class="c1">#     td = (datetime.now()-start).total_seconds()</span>
            <span class="c1">#     print(&quot;...took {0}&quot;.format(td))</span>
            <span class="c1">#     print(&quot;forming ipt-to-point cov...&quot;,end=&#39;&#39;)</span>

            <span class="c1"># calc the interp point to points covariance</span>
            <span class="n">interp_cov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geostruct</span><span class="o">.</span><span class="n">covariance_points</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span><span class="n">iy</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">point_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pt_names</span><span class="p">,</span><span class="s2">&quot;x&quot;</span><span class="p">],</span>
                                                          <span class="bp">self</span><span class="o">.</span><span class="n">point_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pt_names</span><span class="p">,</span><span class="s2">&quot;y&quot;</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">verbose</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">td</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">-</span><span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;...took </span><span class="si">{0}</span><span class="s2"> seconds&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">td</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;forming lin alg components...&quot;</span><span class="p">,</span><span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

            <span class="c1"># form the linear algebra parts and solve</span>
            <span class="n">d</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pt_names</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="c1"># +1 for lagrange mult</span>
            <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">d</span><span class="p">,</span><span class="n">d</span><span class="p">))</span>
            <span class="n">A</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">point_cov</span><span class="o">.</span><span class="n">values</span>
            <span class="n">A</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="c1">#unbiaised constraint</span>
            <span class="n">rhs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">d</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">rhs</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">interp_cov</span>
            <span class="c1"># if verbose == 2:</span>
            <span class="c1">#     td = (datetime.now()-start).total_seconds()</span>
            <span class="c1">#     print(&quot;...took {0}&quot;.format(td))</span>
            <span class="c1">#     print(&quot;solving...&quot;,end=&#39;&#39;)</span>
            <span class="c1"># # solve</span>
            <span class="n">facs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">rhs</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">facs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span>

            <span class="n">err_var</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">sill</span> <span class="o">+</span> <span class="n">facs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="nb">sum</span><span class="p">([</span><span class="n">f</span><span class="o">*</span><span class="n">c</span> <span class="k">for</span> <span class="n">f</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">facs</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">interp_cov</span><span class="p">)])))</span>
            <span class="n">inames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pt_names</span><span class="p">)</span>

            <span class="n">idist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dist</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="n">ifacts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">facs</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
            <span class="c1"># if verbose == 2:</span>
            <span class="c1">#     td = (datetime.now()-start).total_seconds()</span>
            <span class="c1">#     print(&quot;...took {0}&quot;.format(td))</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">td</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">-</span><span class="n">istart</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;point took </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">td</span><span class="p">))</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;idist&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">idist</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;inames&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">inames</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;ifacts&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ifacts</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;err_var&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">err_var</span>
        <span class="k">if</span> <span class="n">pt_zone</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interp_data</span> <span class="o">=</span> <span class="n">df</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interp_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">interp_data</span> <span class="o">=</span> <span class="n">df</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">interp_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interp_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="n">td</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_loop</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;took </span><span class="si">{0}</span><span class="s2"> seconds&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">td</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="OrdinaryKrige.to_grid_factors_file"><a class="viewcode-back" href="../../../_static/pyemu.utils.html#pyemu.utils.geostats.OrdinaryKrige.to_grid_factors_file">[docs]</a>    <span class="k">def</span> <span class="nf">to_grid_factors_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span><span class="n">points_file</span><span class="o">=</span><span class="s2">&quot;points.junk&quot;</span><span class="p">,</span>
                             <span class="n">zone_file</span><span class="o">=</span><span class="s2">&quot;zone.junk&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interp_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;ok.interp_data is None, must call calc_factors_grid() first&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spatial_reference</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;ok.spatial_reference is None, must call calc_factors_grid() first&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">points_file</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">zone_file</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> </span><span class="si">{1}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spatial_reference</span><span class="o">.</span><span class="n">ncol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spatial_reference</span><span class="o">.</span><span class="n">nrow</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">point_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">point_data</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
            <span class="n">t</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geostruct</span><span class="o">.</span><span class="n">transform</span> <span class="o">==</span> <span class="s2">&quot;log&quot;</span><span class="p">:</span>
                <span class="n">t</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">pt_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">point_data</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span><span class="n">names</span><span class="p">,</span><span class="n">facts</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">interp_data</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">interp_data</span><span class="o">.</span><span class="n">inames</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">interp_data</span><span class="o">.</span><span class="n">ifacts</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">facts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">n_idxs</span> <span class="o">=</span> <span class="p">[</span><span class="n">pt_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">]</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> </span><span class="si">{1}</span><span class="s2"> </span><span class="si">{2}</span><span class="s2"> </span><span class="si">{3:8.5e}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">))</span>
                <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> </span><span class="si">{1:12.8g}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">w</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">n_idxs</span><span class="p">,</span> <span class="n">facts</span><span class="p">)]</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="Vario2d"><a class="viewcode-back" href="../../../_static/pyemu.utils.html#pyemu.utils.geostats.Vario2d">[docs]</a><span class="k">class</span> <span class="nc">Vario2d</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;base class for 2-D variograms</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        contribution : float</span>
<span class="sd">            sill of the variogram</span>
<span class="sd">        a : float</span>
<span class="sd">            (practical) range</span>
<span class="sd">        anisotropy : float (optional)</span>
<span class="sd">            Anisotropy ratio. If None, 1.0 used</span>
<span class="sd">        bearing : float (optional)</span>
<span class="sd">            angle in degrees East of North cooresponding to anisotropy ellipse.</span>
<span class="sd">            If None, 0.0 used</span>
<span class="sd">        name : str (optional)</span>
<span class="sd">            name of the variogram</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        Vario2d instance</span>
<span class="sd">    Note</span>
<span class="sd">    ----</span>
<span class="sd">        This base class should not be instantiated directly.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">contribution</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">anisotropy</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span><span class="n">bearing</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;var1&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span> <span class="o">=</span> <span class="n">EPSILON</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contribution</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">contribution</span><span class="p">)</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">contribution</span> <span class="o">&gt;</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">&gt;</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">anisotropy</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">anisotropy</span><span class="p">)</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">anisotropy</span> <span class="o">&gt;</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bearing</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">bearing</span><span class="p">)</span>

<div class="viewcode-block" id="Vario2d.to_struct_file"><a class="viewcode-back" href="../../../_static/pyemu.utils.html#pyemu.utils.geostats.Vario2d.to_struct_file">[docs]</a>    <span class="k">def</span> <span class="nf">to_struct_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;VARIOGRAM </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;  VARTYPE </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vartype</span><span class="p">))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;  A </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;  ANISOTROPY </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">anisotropy</span><span class="p">))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;  BEARING </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bearing</span><span class="p">))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;END VARIOGRAM</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">bearing_rads</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">180.0</span> <span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">90.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">bearing</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">rotation_coefs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bearing_rads</span><span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bearing_rads</span><span class="p">),</span>
                <span class="o">-</span><span class="mf">1.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bearing_rads</span><span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bearing_rads</span><span class="p">)]</span>

<div class="viewcode-block" id="Vario2d.inv_h"><a class="viewcode-back" href="../../../_static/pyemu.utils.html#pyemu.utils.geostats.Vario2d.inv_h">[docs]</a>    <span class="k">def</span> <span class="nf">inv_h</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">h</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">contribution</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_h_function</span><span class="p">(</span><span class="n">h</span><span class="p">)</span></div>

<div class="viewcode-block" id="Vario2d.plot"><a class="viewcode-back" href="../../../_static/pyemu.utils.html#pyemu.utils.geostats.Vario2d.plot">[docs]</a>    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;ax&quot;</span><span class="p">,</span><span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">))</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="o">*</span><span class="mi">3</span><span class="p">,</span><span class="mi">100</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inv_h</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;distance&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;$\gamma$&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ax</span></div>

<div class="viewcode-block" id="Vario2d.covariance_matrix"><a class="viewcode-back" href="../../../_static/pyemu.utils.html#pyemu.utils.geostats.Vario2d.covariance_matrix">[docs]</a>    <span class="k">def</span> <span class="nf">covariance_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">cov</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;build a pyemu.Cov instance from Vario2d</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">            x : iterable of floats</span>
<span class="sd">                x locations</span>
<span class="sd">            y : iterable of floats</span>
<span class="sd">                y locations</span>
<span class="sd">            names : iterable of str (optional)</span>
<span class="sd">                names of location. If None, generic names will be used</span>
<span class="sd">            cov : pyemu.Cov instance (optional)</span>
<span class="sd">                an existing Cov instance to add contribution to</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">            pyemu.Cov</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">names</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)))</span>
            <span class="n">np</span><span class="o">.</span><span class="n">fill_diagonal</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">contribution</span><span class="p">)</span>
            <span class="n">cov</span> <span class="o">=</span> <span class="n">Cov</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">c</span><span class="p">,</span><span class="n">names</span><span class="o">=</span><span class="n">names</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">cov</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">cov</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">names</span> <span class="o">=</span> <span class="n">cov</span><span class="o">.</span><span class="n">row_names</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">),</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">contribution</span>
            <span class="n">cont</span> <span class="o">=</span> <span class="n">Cov</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">c</span><span class="p">,</span><span class="n">names</span><span class="o">=</span><span class="n">names</span><span class="p">,</span><span class="n">isdiagonal</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">cov</span> <span class="o">+=</span> <span class="n">cont</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Vario2d.covariance_matrix() requires either&quot;</span> <span class="o">+</span>
                            <span class="s2">&quot;names or cov arg&quot;</span><span class="p">)</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotation_coefs</span>
        <span class="k">for</span> <span class="n">i1</span><span class="p">,(</span><span class="n">n1</span><span class="p">,</span><span class="n">x1</span><span class="p">,</span><span class="n">y1</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">names</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)):</span>
            <span class="n">dx</span> <span class="o">=</span> <span class="n">x1</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="n">i1</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">dy</span> <span class="o">=</span> <span class="n">y1</span> <span class="o">-</span> <span class="n">y</span><span class="p">[</span><span class="n">i1</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">dxx</span><span class="p">,</span><span class="n">dyy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_rotation</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span><span class="n">dy</span><span class="p">)</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dxx</span><span class="o">*</span><span class="n">dxx</span> <span class="o">+</span> <span class="n">dyy</span><span class="o">*</span><span class="n">dyy</span><span class="p">)</span>

            <span class="n">h</span><span class="p">[</span><span class="n">h</span><span class="o">&lt;</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_h_function</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">h</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;nans in h for i1 </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i1</span><span class="p">))</span>
            <span class="n">cov</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i1</span><span class="p">,</span><span class="n">i1</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+=</span> <span class="n">h</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)):</span>
            <span class="n">cov</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cov</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">return</span> <span class="n">cov</span></div>

    <span class="k">def</span> <span class="nf">_apply_rotation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dx</span><span class="p">,</span><span class="n">dy</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">anisotropy</span> <span class="o">==</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">dx</span><span class="p">,</span><span class="n">dy</span>
        <span class="n">rcoefs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotation_coefs</span>
        <span class="n">dxx</span> <span class="o">=</span> <span class="p">(</span><span class="n">dx</span> <span class="o">*</span> <span class="n">rcoefs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span>\
             <span class="p">(</span><span class="n">dy</span> <span class="o">*</span> <span class="n">rcoefs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">dyy</span> <span class="o">=</span> <span class="p">((</span><span class="n">dx</span> <span class="o">*</span> <span class="n">rcoefs</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">+</span>\
             <span class="p">(</span><span class="n">dy</span> <span class="o">*</span> <span class="n">rcoefs</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span> <span class="o">*</span>\
             <span class="bp">self</span><span class="o">.</span><span class="n">anisotropy</span>
        <span class="k">return</span> <span class="n">dxx</span><span class="p">,</span><span class="n">dyy</span>

<div class="viewcode-block" id="Vario2d.covariance_points"><a class="viewcode-back" href="../../../_static/pyemu.utils.html#pyemu.utils.geostats.Vario2d.covariance_points">[docs]</a>    <span class="k">def</span> <span class="nf">covariance_points</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x0</span><span class="p">,</span><span class="n">y0</span><span class="p">,</span><span class="n">xother</span><span class="p">,</span><span class="n">yother</span><span class="p">):</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="n">x0</span> <span class="o">-</span> <span class="n">xother</span>
        <span class="n">dy</span> <span class="o">=</span> <span class="n">y0</span> <span class="o">-</span> <span class="n">yother</span>
        <span class="n">dxx</span><span class="p">,</span><span class="n">dyy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_rotation</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span><span class="n">dy</span><span class="p">)</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dxx</span><span class="o">*</span><span class="n">dxx</span> <span class="o">+</span> <span class="n">dyy</span><span class="o">*</span><span class="n">dyy</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_h_function</span><span class="p">(</span><span class="n">h</span><span class="p">)</span></div>

<div class="viewcode-block" id="Vario2d.covariance"><a class="viewcode-back" href="../../../_static/pyemu.utils.html#pyemu.utils.geostats.Vario2d.covariance">[docs]</a>    <span class="k">def</span> <span class="nf">covariance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">pt0</span><span class="p">,</span><span class="n">pt1</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pt0</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">pt1</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pt0</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">pt1</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;n1&quot;</span><span class="p">,</span><span class="s2">&quot;n2&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">covariance_matrix</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">names</span><span class="o">=</span><span class="n">names</span><span class="p">)</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span></div>


    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;name:</span><span class="si">{0}</span><span class="s2">,contribution:</span><span class="si">{1}</span><span class="s2">,a:</span><span class="si">{2}</span><span class="s2">,anisotropy:</span><span class="si">{3}</span><span class="s2">,bearing:</span><span class="si">{4}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span>\
            <span class="nb">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">contribution</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">,</span>\
                   <span class="bp">self</span><span class="o">.</span><span class="n">anisotropy</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">bearing</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">s</span></div>

<div class="viewcode-block" id="ExpVario"><a class="viewcode-back" href="../../../_static/pyemu.utils.html#pyemu.utils.geostats.ExpVario">[docs]</a><span class="k">class</span> <span class="nc">ExpVario</span><span class="p">(</span><span class="n">Vario2d</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">contribution</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">anisotropy</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span><span class="n">bearing</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;var1&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Exponential 2-D variograms</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        contribution : float</span>
<span class="sd">            sill of the variogram</span>
<span class="sd">        a : float</span>
<span class="sd">            (practical) range</span>
<span class="sd">        anisotropy : float (optional)</span>
<span class="sd">            Anisotropy ratio. If None, 1.0 used</span>
<span class="sd">        bearing : float (optional)</span>
<span class="sd">            angle in degrees East of North cooresponding to anisotropy ellipse.</span>
<span class="sd">            If None, 0.0 used</span>
<span class="sd">        name : str (optional)</span>
<span class="sd">            name of the variogram</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        ExpVario instance</span>
<span class="sd">    &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ExpVario</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">contribution</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">anisotropy</span><span class="o">=</span><span class="n">anisotropy</span><span class="p">,</span>
                                      <span class="n">bearing</span><span class="o">=</span><span class="n">bearing</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vartype</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="k">def</span> <span class="nf">_h_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">h</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">contribution</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">h</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">)</span></div>

<div class="viewcode-block" id="GauVario"><a class="viewcode-back" href="../../../_static/pyemu.utils.html#pyemu.utils.geostats.GauVario">[docs]</a><span class="k">class</span> <span class="nc">GauVario</span><span class="p">(</span><span class="n">Vario2d</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Gaussian 2-D variograms</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        contribution : float</span>
<span class="sd">            sill of the variogram</span>
<span class="sd">        a : float</span>
<span class="sd">            (practical) range</span>
<span class="sd">        anisotropy : float (optional)</span>
<span class="sd">            Anisotropy ratio. If None, 1.0 used</span>
<span class="sd">        bearing : float (optional)</span>
<span class="sd">            angle in degrees East of North cooresponding to anisotropy ellipse.</span>
<span class="sd">            If None, 0.0 used</span>
<span class="sd">        name : str (optional)</span>
<span class="sd">            name of the variogram</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        GauVario instance</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">contribution</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">anisotropy</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span><span class="n">bearing</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;var1&quot;</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">GauVario</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">contribution</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">anisotropy</span><span class="o">=</span><span class="n">anisotropy</span><span class="p">,</span>
                                      <span class="n">bearing</span><span class="o">=</span><span class="n">bearing</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vartype</span> <span class="o">=</span> <span class="mi">3</span>

    <span class="k">def</span> <span class="nf">_h_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">h</span><span class="p">):</span>
        <span class="n">hh</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">h</span> <span class="o">*</span> <span class="n">h</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">contribution</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">hh</span><span class="p">)</span></div>

<div class="viewcode-block" id="SphVario"><a class="viewcode-back" href="../../../_static/pyemu.utils.html#pyemu.utils.geostats.SphVario">[docs]</a><span class="k">class</span> <span class="nc">SphVario</span><span class="p">(</span><span class="n">Vario2d</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Spherical 2-D variograms</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        contribution : float</span>
<span class="sd">            sill of the variogram</span>
<span class="sd">        a : float</span>
<span class="sd">            (practical) range</span>
<span class="sd">        anisotropy : float (optional)</span>
<span class="sd">            Anisotropy ratio. If None, 1.0 used</span>
<span class="sd">        bearing : float (optional)</span>
<span class="sd">            angle in degrees East of North cooresponding to anisotropy ellipse.</span>
<span class="sd">            If None, 0.0 used</span>
<span class="sd">        name : str (optional)</span>
<span class="sd">            name of the variogram</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        SphVario instance</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">contribution</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">anisotropy</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span><span class="n">bearing</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;var1&quot;</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SphVario</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">contribution</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">anisotropy</span><span class="o">=</span><span class="n">anisotropy</span><span class="p">,</span>
                                      <span class="n">bearing</span><span class="o">=</span><span class="n">bearing</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vartype</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">_h_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">h</span><span class="p">):</span>

        <span class="n">hh</span> <span class="o">=</span> <span class="n">h</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span>
        <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">contribution</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="n">hh</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.5</span> <span class="o">-</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">hh</span> <span class="o">*</span> <span class="n">hh</span><span class="p">))))</span>
        <span class="n">h</span><span class="p">[</span><span class="n">hh</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">return</span> <span class="n">h</span></div>
        <span class="c1"># try:</span>
        <span class="c1">#     h[hh &lt; 1.0] = 0.0</span>
        <span class="c1">#</span>
        <span class="c1"># except TypeError:</span>
        <span class="c1">#     if hh &gt; 0.0:</span>
        <span class="c1">#         h = 0.0</span>
        <span class="c1">#return h</span>
        <span class="c1"># if hh &lt; 1.0:</span>
        <span class="c1">#     return self.contribution * (1.0 - (hh * (1.5 - (0.5 * hh * hh))))</span>
        <span class="c1"># else:</span>
        <span class="c1">#     return 0.0</span>





<div class="viewcode-block" id="read_struct_file"><a class="viewcode-back" href="../../../_static/pyemu.utils.html#pyemu.utils.geostats.read_struct_file">[docs]</a><span class="k">def</span> <span class="nf">read_struct_file</span><span class="p">(</span><span class="n">struct_file</span><span class="p">,</span><span class="n">return_type</span><span class="o">=</span><span class="n">GeoStruct</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;read an existing structure file into a GeoStruct instance</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        struct_file : str</span>
<span class="sd">            existing pest-type structure file</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        GeoStruct instance</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">VARTYPE</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span><span class="n">SphVario</span><span class="p">,</span><span class="mi">2</span><span class="p">:</span><span class="n">ExpVario</span><span class="p">,</span><span class="mi">3</span><span class="p">:</span><span class="n">GauVario</span><span class="p">,</span><span class="mi">4</span><span class="p">:</span><span class="kc">None</span><span class="p">}</span>
    <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">struct_file</span><span class="p">)</span>
    <span class="n">structures</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">variograms</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">struct_file</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;structure&quot;</span><span class="p">):</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">nugget</span><span class="p">,</span><span class="n">transform</span><span class="p">,</span><span class="n">variogram_info</span> <span class="o">=</span> <span class="n">_read_structure_attributes</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">return_type</span><span class="p">(</span><span class="n">nugget</span><span class="o">=</span><span class="n">nugget</span><span class="p">,</span><span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
                <span class="n">s</span><span class="o">.</span><span class="n">variogram_info</span> <span class="o">=</span> <span class="n">variogram_info</span>
                <span class="c1"># not sure what is going on, but if I don&#39;t copy s here,</span>
                <span class="c1"># all the structures end up sharing all the variograms later</span>
                <span class="n">structures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;variogram&quot;</span><span class="p">):</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="n">vartype</span><span class="p">,</span><span class="n">bearing</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">anisotropy</span> <span class="o">=</span> <span class="n">_read_variogram</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">variogram_info</span><span class="p">:</span>
                    <span class="n">v</span> <span class="o">=</span> <span class="n">VARTYPE</span><span class="p">[</span><span class="n">vartype</span><span class="p">](</span><span class="n">variogram_info</span><span class="p">[</span><span class="n">name</span><span class="p">],</span><span class="n">a</span><span class="p">,</span><span class="n">anisotropy</span><span class="o">=</span><span class="n">anisotropy</span><span class="p">,</span>
                                         <span class="n">bearing</span><span class="o">=</span><span class="n">bearing</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
                    <span class="n">variograms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">st</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">structures</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">vname</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">variogram_info</span><span class="p">:</span>
            <span class="n">vfound</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">variograms</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">vname</span><span class="p">:</span>
                    <span class="n">vfound</span> <span class="o">=</span> <span class="n">v</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="n">vfound</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;variogram </span><span class="si">{0}</span><span class="s2"> not found for structure </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span>\
                                <span class="nb">format</span><span class="p">(</span><span class="n">vname</span><span class="p">,</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

            <span class="n">st</span><span class="o">.</span><span class="n">variograms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vfound</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">structures</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">structures</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">structures</span></div>



<span class="k">def</span> <span class="nf">_read_variogram</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">vartype</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">bearing</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">a</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">anisotropy</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="k">while</span> <span class="s2">&quot;end variogram&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;EOF while read variogram&quot;</span><span class="p">)</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;vartype&quot;</span><span class="p">:</span>
            <span class="n">vartype</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;bearing&quot;</span><span class="p">:</span>
            <span class="n">bearing</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;a&quot;</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;anisotropy&quot;</span><span class="p">:</span>
            <span class="n">anisotropy</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;end&quot;</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;unrecognized arg in variogram:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">vartype</span><span class="p">,</span><span class="n">bearing</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">anisotropy</span>


<span class="k">def</span> <span class="nf">_read_structure_attributes</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">variogram_info</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">while</span> <span class="s2">&quot;end structure&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;EOF while reading structure&quot;</span><span class="p">)</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;nugget&quot;</span><span class="p">:</span>
            <span class="n">nugget</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;transform&quot;</span><span class="p">:</span>
            <span class="n">transform</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;numvariogram&quot;</span><span class="p">:</span>
            <span class="n">numvariograms</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;variogram&quot;</span><span class="p">:</span>
            <span class="n">variogram_info</span><span class="p">[</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;end&quot;</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;unrecognized line in structure definition:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span>\
                            <span class="nb">format</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="k">assert</span> <span class="n">numvariograms</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">variogram_info</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">nugget</span><span class="p">,</span><span class="n">transform</span><span class="p">,</span><span class="n">variogram_info</span>


<div class="viewcode-block" id="read_sgems_variogram_xml"><a class="viewcode-back" href="../../../_static/pyemu.utils.html#pyemu.utils.geostats.read_sgems_variogram_xml">[docs]</a><span class="k">def</span> <span class="nf">read_sgems_variogram_xml</span><span class="p">(</span><span class="n">xml_file</span><span class="p">,</span><span class="n">return_type</span><span class="o">=</span><span class="n">GeoStruct</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">xml.etree.ElementTree</span> <span class="k">as</span> <span class="nn">ET</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;error import elementtree, skipping...&quot;</span><span class="p">)</span>
    <span class="n">VARTYPE</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="n">SphVario</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="n">ExpVario</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span> <span class="n">GauVario</span><span class="p">,</span> <span class="mi">4</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
    <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">xml_file</span><span class="p">)</span>
    <span class="n">tree</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">xml_file</span><span class="p">)</span>
    <span class="n">gs_model</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span>
    <span class="n">structures</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">variograms</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">nugget</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">num_struct</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">val</span> <span class="ow">in</span> <span class="n">gs_model</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1">#print(key,val)</span>
        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;nugget&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">nugget</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;structures_count&quot;</span><span class="p">:</span>
            <span class="n">num_struct</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">num_struct</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;no structures found&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">num_struct</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">structure</span> <span class="ow">in</span> <span class="n">gs_model</span><span class="p">:</span>
        <span class="n">vtype</span><span class="p">,</span> <span class="n">contribution</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="n">mx_range</span><span class="p">,</span><span class="n">mn_range</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="n">x_angle</span><span class="p">,</span><span class="n">y_angle</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="kc">None</span>
        <span class="c1">#struct_name = structure.tag</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">val</span> <span class="ow">in</span> <span class="n">structure</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span>
                <span class="n">vtype</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">vtype</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;sph&quot;</span><span class="p">):</span>
                    <span class="n">vtype</span> <span class="o">=</span> <span class="n">SphVario</span>
                <span class="k">elif</span> <span class="n">vtype</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;exp&quot;</span><span class="p">):</span>
                    <span class="n">vtype</span> <span class="o">=</span> <span class="n">ExpVario</span>
                <span class="k">elif</span> <span class="n">vtype</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;gau&quot;</span><span class="p">):</span>
                    <span class="n">vtype</span> <span class="o">=</span> <span class="n">GauVario</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;unrecognized variogram type:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">vtype</span><span class="p">))</span>

            <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;contribution&quot;</span><span class="p">:</span>
                <span class="n">contribution</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">structure</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;ranges&quot;</span><span class="p">:</span>
                    <span class="n">mx_range</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;max&quot;</span><span class="p">])</span>
                    <span class="n">mn_range</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;min&quot;</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">item</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;angles&quot;</span><span class="p">:</span>
                    <span class="n">x_angle</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">])</span>
                    <span class="n">y_angle</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">])</span>

        <span class="k">assert</span> <span class="n">contribution</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="n">mn_range</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="n">mx_range</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="n">x_angle</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="n">y_angle</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="n">vtype</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">vtype</span><span class="p">(</span><span class="n">contribution</span><span class="o">=</span><span class="n">contribution</span><span class="p">,</span><span class="n">a</span><span class="o">=</span><span class="n">mx_range</span><span class="p">,</span>
                  <span class="n">anisotropy</span><span class="o">=</span><span class="n">mx_range</span><span class="o">/</span><span class="n">mn_range</span><span class="p">,</span><span class="n">bearing</span><span class="o">=</span><span class="p">(</span><span class="mf">180.0</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">x_angle</span><span class="p">,</span><span class="n">y_angle</span><span class="p">),</span>
                  <span class="n">name</span><span class="o">=</span><span class="n">structure</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">GeoStruct</span><span class="p">(</span><span class="n">nugget</span><span class="o">=</span><span class="n">nugget</span><span class="p">,</span><span class="n">variograms</span><span class="o">=</span><span class="p">[</span><span class="n">v</span><span class="p">])</span></div>


<div class="viewcode-block" id="gslib_2_dataframe"><a class="viewcode-back" href="../../../_static/pyemu.utils.html#pyemu.utils.geostats.gslib_2_dataframe">[docs]</a><span class="k">def</span> <span class="nf">gslib_2_dataframe</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">attr_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">x_idx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">y_idx</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">num_attrs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_attrs</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">attr_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">attr_name</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">,</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> not in attrs:</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr_name</span><span class="p">,</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">attrs</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">attrs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">,</span><span class="s2">&quot;propname is None but more than 3 attrs in gslib file&quot;</span>
            <span class="n">attr_name</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">attrs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">x_idx</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">attrs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">y_idx</span>
        <span class="n">a_idx</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">attr_name</span><span class="p">)</span>
        <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">a</span> <span class="o">=</span> <span class="p">[],[],[]</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">raw</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">raw</span><span class="p">[</span><span class="n">x_idx</span><span class="p">]))</span>
                <span class="n">y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">raw</span><span class="p">[</span><span class="n">y_idx</span><span class="p">]))</span>
                <span class="n">a</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">raw</span><span class="p">[</span><span class="n">a_idx</span><span class="p">]))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;error paring line </span><span class="si">{0}</span><span class="s2">: </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;x&quot;</span><span class="p">:</span><span class="n">x</span><span class="p">,</span><span class="s2">&quot;y&quot;</span><span class="p">:</span><span class="n">y</span><span class="p">,</span><span class="s2">&quot;value&quot;</span><span class="p">:</span><span class="n">a</span><span class="p">})</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;pt</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
    <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">name</span>
    <span class="k">return</span> <span class="n">df</span></div>


<span class="c1">#class ExperimentalVariogram(object):</span>
<span class="c1">#    def __init__(self,na)</span>

<div class="viewcode-block" id="load_sgems_exp_var"><a class="viewcode-back" href="../../../_static/pyemu.utils.html#pyemu.utils.geostats.load_sgems_exp_var">[docs]</a><span class="k">def</span> <span class="nf">load_sgems_exp_var</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="kn">import</span> <span class="nn">xml.etree.ElementTree</span> <span class="k">as</span> <span class="nn">etree</span>
    <span class="n">tree</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">root</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span>
    <span class="n">dfs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">variogram</span> <span class="ow">in</span> <span class="n">root</span><span class="p">:</span>
        <span class="c1">#print(variogram.tag)</span>
        <span class="k">for</span> <span class="n">attrib</span> <span class="ow">in</span> <span class="n">variogram</span><span class="p">:</span>

            <span class="c1">#print(attrib.tag,attrib.text)</span>
            <span class="k">if</span> <span class="n">attrib</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;title&quot;</span><span class="p">:</span>
                <span class="n">title</span> <span class="o">=</span> <span class="n">attrib</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">attrib</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;x&quot;</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">attrib</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span>
            <span class="k">elif</span> <span class="n">attrib</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span>
                <span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">attrib</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span>
            <span class="k">elif</span> <span class="n">attrib</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;pairs&quot;</span><span class="p">:</span>
                <span class="n">pairs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">attrib</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span>

            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">attrib</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">item</span><span class="p">,</span><span class="n">item</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;x&quot;</span><span class="p">:</span><span class="n">x</span><span class="p">,</span><span class="s2">&quot;y&quot;</span><span class="p">:</span><span class="n">y</span><span class="p">,</span><span class="s2">&quot;pairs&quot;</span><span class="p">:</span><span class="n">pairs</span><span class="p">})</span>
        <span class="n">dfs</span><span class="p">[</span><span class="n">title</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span>
    <span class="k">return</span> <span class="n">dfs</span></div>



<div class="viewcode-block" id="fac2real"><a class="viewcode-back" href="../../../_static/pyemu.utils.html#pyemu.utils.geostats.fac2real">[docs]</a><span class="k">def</span> <span class="nf">fac2real</span><span class="p">(</span><span class="n">pp_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">factors_file</span><span class="o">=</span><span class="s2">&quot;factors.dat&quot;</span><span class="p">,</span><span class="n">out_file</span><span class="o">=</span><span class="s2">&quot;test.ref&quot;</span><span class="p">,</span>
             <span class="n">upper_lim</span><span class="o">=</span><span class="mf">1.0e+30</span><span class="p">,</span><span class="n">lower_lim</span><span class="o">=-</span><span class="mf">1.0e+30</span><span class="p">,</span><span class="n">fill_value</span><span class="o">=</span><span class="mf">1.0e+30</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A python replication of the PEST fac2real utility</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        pp_file : str</span>
<span class="sd">            existing pilot points file</span>
<span class="sd">        factors_file : str</span>
<span class="sd">            existing factors file from ppk2fac, etc</span>
<span class="sd">        out_file : str</span>
<span class="sd">            filename of array to write</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">pp_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pp_file</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pp_file</span><span class="p">)</span>
        <span class="c1"># pp_data = pd.read_csv(pp_file,delim_whitespace=True,header=None,</span>
        <span class="c1">#                       names=[&quot;name&quot;,&quot;parval1&quot;],usecols=[0,4])</span>
        <span class="n">pp_data</span> <span class="o">=</span> <span class="n">pp_file_to_dataframe</span><span class="p">(</span><span class="n">pp_file</span><span class="p">)</span>
        <span class="n">pp_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pp_data</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
    <span class="k">elif</span> <span class="n">pp_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pp_file</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="k">assert</span> <span class="s2">&quot;name&quot;</span> <span class="ow">in</span> <span class="n">pp_file</span><span class="o">.</span><span class="n">columns</span>
        <span class="k">assert</span> <span class="s2">&quot;parval1&quot;</span> <span class="ow">in</span> <span class="n">pp_file</span><span class="o">.</span><span class="n">columns</span>
        <span class="n">pp_data</span> <span class="o">=</span> <span class="n">pp_file</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;unrecognized pp_file arg: must be str or pandas.DataFrame, not </span><span class="si">{0}</span><span class="s2">&quot;</span>\
                        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">pp_file</span><span class="p">)))</span>
    <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">factors_file</span><span class="p">)</span>
    <span class="n">f_fac</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">factors_file</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">fpp_file</span> <span class="o">=</span> <span class="n">f_fac</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">pp_file</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">pp_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">pp_data</span> <span class="o">=</span> <span class="n">pp_file_to_dataframe</span><span class="p">(</span><span class="n">fpp_file</span><span class="p">)</span>
        <span class="n">pp_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pp_data</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>

    <span class="n">fzone_file</span> <span class="o">=</span> <span class="n">f_fac</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
    <span class="n">ncol</span><span class="p">,</span><span class="n">nrow</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">f_fac</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span>
    <span class="n">npp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">f_fac</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
    <span class="n">pp_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">f_fac</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npp</span><span class="p">)]</span>

    <span class="c1"># check that pp_names is sync&#39;d with pp_data</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">pp_data</span><span class="o">.</span><span class="n">name</span><span class="p">))</span><span class="o">.</span><span class="n">symmetric_difference</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">pp_names</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;the following pilot point names are not common &quot;</span> <span class="o">+</span>\
                        <span class="s2">&quot;between the factors file and the pilot points file &quot;</span> <span class="o">+</span>\
                        <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">diff</span><span class="p">)))</span>

    <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nrow</span><span class="p">,</span><span class="n">ncol</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span> <span class="o">+</span> <span class="n">fill_value</span>
    <span class="n">pp_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span><span class="n">val</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span><span class="n">val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">pp_data</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">pp_data</span><span class="o">.</span><span class="n">parval1</span><span class="p">)}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">pp_dict_log</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span><span class="n">val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">pp_data</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">pp_data</span><span class="o">.</span><span class="n">parval1</span><span class="p">)}</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">pp_dict_log</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1">#for i in range(nrow):</span>
    <span class="c1">#    for j in range(ncol):</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">f_fac</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1">#raise Exception(&quot;unexpected EOF in factors file&quot;)</span>
            <span class="k">break</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">inode</span><span class="p">,</span><span class="n">itrans</span><span class="p">,</span><span class="n">fac_data</span> <span class="o">=</span> <span class="n">parse_factor_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;error parsing factor line </span><span class="si">{0}</span><span class="s2">:</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
        <span class="c1">#fac_prods = [pp_data.loc[pp,&quot;value&quot;]*fac_data[pp] for pp in fac_data]</span>
        <span class="k">if</span> <span class="n">itrans</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">fac_sum</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">pp_dict</span><span class="p">[</span><span class="n">pp</span><span class="p">]</span> <span class="o">*</span> <span class="n">fac_data</span><span class="p">[</span><span class="n">pp</span><span class="p">]</span> <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">fac_data</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fac_sum</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">pp_dict_log</span><span class="p">[</span><span class="n">pp</span><span class="p">]</span> <span class="o">*</span> <span class="n">fac_data</span><span class="p">[</span><span class="n">pp</span><span class="p">]</span> <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">fac_data</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">itrans</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">fac_sum</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="n">fac_sum</span>
        <span class="c1">#col = ((inode - 1) // nrow) + 1</span>
        <span class="c1">#row = inode - ((col - 1) * nrow)</span>
        <span class="n">row</span> <span class="o">=</span> <span class="p">((</span><span class="n">inode</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">ncol</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">col</span> <span class="o">=</span> <span class="n">inode</span> <span class="o">-</span> <span class="p">((</span><span class="n">row</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">ncol</span><span class="p">)</span>
        <span class="c1">#arr[row-1,col-1] = np.sum(np.array(fac_prods))</span>
        <span class="n">arr</span><span class="p">[</span><span class="n">row</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">col</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">fac_sum</span>
    <span class="n">arr</span><span class="p">[</span><span class="n">arr</span><span class="o">&lt;</span><span class="n">lower_lim</span><span class="p">]</span> <span class="o">=</span> <span class="n">lower_lim</span>
    <span class="n">arr</span><span class="p">[</span><span class="n">arr</span><span class="o">&gt;</span><span class="n">upper_lim</span><span class="p">]</span> <span class="o">=</span> <span class="n">upper_lim</span>
    <span class="k">if</span> <span class="n">out_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">out_file</span><span class="p">,</span><span class="n">arr</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%15.6E</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out_file</span>
    <span class="k">return</span> <span class="n">arr</span></div>

<div class="viewcode-block" id="parse_factor_line"><a class="viewcode-back" href="../../../_static/pyemu.utils.html#pyemu.utils.geostats.parse_factor_line">[docs]</a><span class="k">def</span> <span class="nf">parse_factor_line</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
    <span class="n">raw</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">inode</span><span class="p">,</span><span class="n">itrans</span><span class="p">,</span><span class="n">nfac</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">raw</span><span class="p">[:</span><span class="mi">3</span><span class="p">]]</span>
    <span class="n">fac_data</span> <span class="o">=</span> <span class="p">{</span><span class="nb">int</span><span class="p">(</span><span class="n">raw</span><span class="p">[</span><span class="n">ifac</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="nb">float</span><span class="p">(</span><span class="n">raw</span><span class="p">[</span><span class="n">ifac</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">ifac</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="o">+</span><span class="n">nfac</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)}</span>
    <span class="c1"># fac_data = {}</span>
    <span class="c1"># for ifac in range(4,4+nfac*2,2):</span>
    <span class="c1">#     pnum = int(raw[ifac]) - 1 #zero based to sync with pandas</span>
    <span class="c1">#     fac = float(raw[ifac+1])</span>
    <span class="c1">#     fac_data[pnum] = fac</span>
    <span class="k">return</span> <span class="n">inode</span><span class="p">,</span><span class="n">itrans</span><span class="p">,</span><span class="n">fac_data</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017, Jeremy White.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.5.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.9</a>
      
    </div>

    

    
  </body>
</html>